<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Success Meeting Tracker</title>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        // Lucide icons as inline SVGs
        const UploadIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
        );

        const DownloadIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const SearchIcon = () => (
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        const CalendarIcon = () => (
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        );

        const MapPinIcon = () => (
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
        );

        const UsersIcon = () => (
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const FileTextIcon = () => (
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
        );

        const StudentSuccessMeetings = () => {
            const [meetings, setMeetings] = useState([]);
            const [filteredMeetings, setFilteredMeetings] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortConfig, setSortConfig] = useState({ key: 'startDate', direction: 'asc' });
            const [fileUploaded, setFileUploaded] = useState(false);
            const [error, setError] = useState(null);
            const [uniqueStudents, setUniqueStudents] = useState([]);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const content = e.target.result;
                        const parsedMeetings = parseICS(content);
                        
                        if (parsedMeetings.length === 0) {
                            setError('No "Student Success Mtg." or "SON Success Coach Mtg." meetings found in your calendar.');
                        } else {
                            setError(null);
                        }
                        
                        setMeetings(parsedMeetings);
                        setFilteredMeetings(parsedMeetings);
                        
                        // Extract unique students from meeting titles
                        const studentNames = new Set();
                        parsedMeetings.forEach(meeting => {
                            if (meeting.studentName && meeting.studentName.length > 0) {
                                studentNames.add(meeting.studentName);
                            }
                        });
                        
                        setUniqueStudents(Array.from(studentNames).sort());
                        setFileUploaded(true);
                    } catch (err) {
                        setError('Error parsing calendar file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };

            const parseICS = (icsContent) => {
                const events = [];
                const lines = icsContent.split('\n');
                let currentEvent = null;
                let inEvent = false;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();

                    if (line === 'BEGIN:VEVENT') {
                        inEvent = true;
                        currentEvent = {
                            summary: '',
                            description: '',
                            location: '',
                            startDate: '',
                            endDate: '',
                            startTime: '',
                            endTime: '',
                            organizer: '',
                            attendees: [],
                            status: '',
                            created: '',
                            lastModified: ''
                        };
                    } else if (line === 'END:VEVENT' && currentEvent) {
                        if (currentEvent.summary.includes('Student Success Mtg.') || 
                            currentEvent.summary.includes('SON Success Coach Mtg.')) {
                            // Extract student name from title
                            let studentName = currentEvent.summary
                                .replace('Student Success Mtg.', '')
                                .replace('SON Success Coach Mtg.', '')
                                .trim();
                            studentName = studentName.replace(/^[-:\/]\s*/, '').trim();
                            // Remove parentheses
                            studentName = studentName.replace(/^\(/, '').replace(/\)$/, '').trim();
                            currentEvent.studentName = studentName;
                            
                            // Split date into separate components
                            if (currentEvent.startDate) {
                                const [year, month, day] = currentEvent.startDate.split('-');
                                currentEvent.year = year;
                                currentEvent.month = month;
                                currentEvent.day = day;
                            }
                            
                            events.push(currentEvent);
                        }
                        inEvent = false;
                        currentEvent = null;
                    } else if (inEvent && currentEvent) {
                        if (line.startsWith('SUMMARY:')) {
                            currentEvent.summary = line.substring(8).replace(/\\,/g, ',').replace(/\\;/g, ';');
                        } else if (line.startsWith('DTSTART')) {
                            const datetime = extractDateTime(line);
                            currentEvent.startDate = datetime.date;
                            currentEvent.startTime = datetime.time;
                        } else if (line.startsWith('DTEND')) {
                            const datetime = extractDateTime(line);
                            currentEvent.endDate = datetime.date;
                            currentEvent.endTime = datetime.time;
                        } else if (line.startsWith('LOCATION:')) {
                            currentEvent.location = line.substring(9).replace(/\\,/g, ',').replace(/\\;/g, ';');
                        } else if (line.startsWith('DESCRIPTION:')) {
                            let desc = line.substring(12);
                            while (i + 1 < lines.length && lines[i + 1].startsWith(' ')) {
                                i++;
                                desc += lines[i].trim();
                            }
                            currentEvent.description = desc.replace(/\\n/g, ' ').replace(/\\,/g, ',').replace(/\\;/g, ';');
                        } else if (line.startsWith('ORGANIZER')) {
                            const emailMatch = line.match(/mailto:([^:]+)/);
                            if (emailMatch) {
                                currentEvent.organizer = emailMatch[1];
                            }
                        } else if (line.startsWith('ATTENDEE')) {
                            const emailMatch = line.match(/mailto:([^:]+)/);
                            if (emailMatch) {
                                currentEvent.attendees.push(emailMatch[1]);
                            }
                        } else if (line.startsWith('STATUS:')) {
                            currentEvent.status = line.substring(7);
                        } else if (line.startsWith('CREATED:')) {
                            currentEvent.created = formatICSDateTime(line.substring(8));
                        } else if (line.startsWith('LAST-MODIFIED:')) {
                            currentEvent.lastModified = formatICSDateTime(line.substring(14));
                        }
                    }
                }

                return events.sort((a, b) => a.startDate.localeCompare(b.startDate));
            };

            const extractDateTime = (line) => {
                const match = line.match(/(\d{8})(T(\d{6}))?/);
                if (match) {
                    const dateStr = match[1];
                    const timeStr = match[3];
                    
                    const year = dateStr.substring(0, 4);
                    const month = dateStr.substring(4, 6);
                    const day = dateStr.substring(6, 8);
                    const date = `${year}-${month}-${day}`;
                    
                    let time = '';
                    if (timeStr) {
                        const hour = timeStr.substring(0, 2);
                        const minute = timeStr.substring(2, 4);
                        time = `${hour}:${minute}`;
                    }
                    
                    return { date, time };
                }
                return { date: '', time: '' };
            };

            const formatICSDateTime = (datetime) => {
                if (datetime.length >= 8) {
                    const year = datetime.substring(0, 4);
                    const month = datetime.substring(4, 6);
                    const day = datetime.substring(6, 8);
                    return `${year}-${month}-${day}`;
                }
                return datetime;
            };

            const filterMeetings = (term) => {
                setSearchTerm(term);
                if (!term) {
                    setFilteredMeetings(meetings);
                    return;
                }

                const filtered = meetings.filter(meeting => 
                    meeting.summary.toLowerCase().includes(term.toLowerCase()) ||
                    meeting.studentName.toLowerCase().includes(term.toLowerCase()) ||
                    meeting.location.toLowerCase().includes(term.toLowerCase()) ||
                    meeting.description.toLowerCase().includes(term.toLowerCase()) ||
                    meeting.organizer.toLowerCase().includes(term.toLowerCase())
                );
                setFilteredMeetings(filtered);
            };

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });

                const sorted = [...filteredMeetings].sort((a, b) => {
                    let aVal = a[key];
                    let bVal = b[key];

                    if (key === 'attendees') {
                        aVal = a[key].length;
                        bVal = b[key].length;
                    }

                    if (aVal < bVal) return direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return direction === 'asc' ? 1 : -1;
                    return 0;
                });

                setFilteredMeetings(sorted);
            };

            const exportToCSV = () => {
                try {
                    const headers = ['Student Name', 'Year', 'Month', 'Day', 'Full Date', 'Start Time', 'End Time', 'Title', 'Location', 'Organizer', 'Attendees', 'Description', 'Status', 'Created', 'Last Modified'];
                    const csvRows = [headers.join(',')];

                    filteredMeetings.forEach(meeting => {
                        const escapeCsvField = (field) => {
                            if (!field) return '""';
                            const str = String(field).replace(/"/g, '""');
                            return `"${str}"`;
                        };

                        const row = [
                            escapeCsvField(meeting.studentName),
                            meeting.year || '',
                            meeting.month || '',
                            meeting.day || '',
                            meeting.startDate || '',
                            meeting.startTime || '',
                            meeting.endTime || '',
                            escapeCsvField(meeting.summary),
                            escapeCsvField(meeting.location),
                            meeting.organizer || '',
                            escapeCsvField(meeting.attendees.join('; ')),
                            escapeCsvField(meeting.description),
                            meeting.status || '',
                            meeting.created || '',
                            meeting.lastModified || ''
                        ];
                        csvRows.push(row.join(','));
                    });

                    const csvContent = csvRows.join('\n');
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'student_success_meetings.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (error) {
                    alert('Error exporting CSV: ' + error.message);
                }
            };

            if (!fileUploaded) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8 flex items-center justify-center">
                        <div className="bg-white rounded-xl shadow-lg p-12 max-w-md text-center">
                            <div className="mx-auto mb-6 text-indigo-600">
                                <UploadIcon />
                            </div>
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Upload Your Calendar File</h2>
                            <p className="text-gray-600 mb-6">
                                Please upload your Google Calendar .ics file to view your Student Success and SON Success Coach meetings.
                            </p>
                            <label className="inline-block">
                                <input
                                    type="file"
                                    accept=".ics"
                                    onChange={handleFileUpload}
                                    className="hidden"
                                />
                                <span className="cursor-pointer bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition inline-flex items-center gap-2">
                                    <UploadIcon />
                                    Choose File
                                </span>
                            </label>
                            {error && (
                                <div className="mt-6 bg-red-50 border border-red-200 rounded-lg p-4">
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-6">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800 flex items-center gap-2">
                                        <CalendarIcon />
                                        Student Success Meetings
                                    </h1>
                                    <p className="text-gray-600 mt-1">
                                        Found {filteredMeetings.length} meetings (all years) • {uniqueStudents.length} unique students
                                    </p>
                                </div>
                                <button
                                    onClick={exportToCSV}
                                    className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
                                >
                                    <DownloadIcon />
                                    Export CSV
                                </button>
                            </div>

                            <div className="relative">
                                <div className="absolute left-3 top-3 text-gray-400">
                                    <SearchIcon />
                                </div>
                                <input
                                    type="text"
                                    placeholder="Search meetings..."
                                    value={searchTerm}
                                    onChange={(e) => filterMeetings(e.target.value)}
                                    className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                />
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-indigo-600 text-white">
                                        <tr>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('studentName')}>
                                                Student Name {sortConfig.key === 'studentName' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('year')}>
                                                Year {sortConfig.key === 'year' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('month')}>
                                                Month {sortConfig.key === 'month' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('day')}>
                                                Day {sortConfig.key === 'day' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('startDate')}>
                                                Full Date {sortConfig.key === 'startDate' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('startTime')}>
                                                Time {sortConfig.key === 'startTime' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('summary')}>
                                                Title {sortConfig.key === 'summary' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('location')}>
                                                Location {sortConfig.key === 'location' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left cursor-pointer hover:bg-indigo-700" onClick={() => handleSort('organizer')}>
                                                Organizer {sortConfig.key === 'organizer' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
                                            </th>
                                            <th className="px-4 py-3 text-left">Details</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {filteredMeetings.map((meeting, index) => (
                                            <tr key={index} className="hover:bg-gray-50">
                                                <td className="px-4 py-3 text-sm font-medium text-indigo-700">{meeting.studentName}</td>
                                                <td className="px-4 py-3 text-sm text-gray-800">{meeting.year}</td>
                                                <td className="px-4 py-3 text-sm text-gray-800">{meeting.month}</td>
                                                <td className="px-4 py-3 text-sm text-gray-800">{meeting.day}</td>
                                                <td className="px-4 py-3 text-sm text-gray-800">{meeting.startDate}</td>
                                                <td className="px-4 py-3 text-sm text-gray-600">
                                                    {meeting.startTime} - {meeting.endTime}
                                                </td>
                                                <td className="px-4 py-3 text-sm font-medium text-gray-800">{meeting.summary}</td>
                                                <td className="px-4 py-3 text-sm text-gray-600">
                                                    {meeting.location && (
                                                        <span className="flex items-center gap-1">
                                                            <MapPinIcon />
                                                            {meeting.location}
                                                        </span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-gray-600">{meeting.organizer}</td>
                                                <td className="px-4 py-3 text-sm">
                                                    <div className="space-y-1">
                                                        {meeting.attendees.length > 0 && (
                                                            <div className="flex items-start gap-1 text-gray-600">
                                                                <UsersIcon />
                                                                <span className="text-xs">{meeting.attendees.length} attendees</span>
                                                            </div>
                                                        )}
                                                        {meeting.description && (
                                                            <div className="flex items-start gap-1 text-gray-600">
                                                                <FileTextIcon />
                                                                <span className="text-xs line-clamp-2">{meeting.description}</span>
                                                            </div>
                                                        )}
                                                        {meeting.status && (
                                                            <span className="inline-block px-2 py-1 text-xs bg-gray-100 rounded">{meeting.status}</span>
                                                        )}
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {filteredMeetings.length === 0 && meetings.length > 0 && (
                            <div className="bg-white rounded-xl shadow-lg p-12 text-center mt-6">
                                <CalendarIcon />
                                <p className="text-gray-600">No meetings found matching your search.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<StudentSuccessMeetings />, document.getElementById('root'));
    </script>
</body>
</html>
